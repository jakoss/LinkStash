# Phase 3 — Auth (Raindrop OAuth + LinkStash Sessions)

## Goal
Implement auth end-to-end:
- Start OAuth with Raindrop
- Exchange auth code for Raindrop tokens (server-side)
- Store tokens encrypted at rest
- Issue LinkStash session (cookie for web, bearer for mobile)
- Refresh Raindrop tokens as needed

## Scope
In scope:
- `/v1/auth/raindrop/start`
- `/v1/auth/raindrop/exchange`
- `/v1/me`
- `/v1/auth/logout`
- Session storage in DB (opaque token recommended)
- Token refresh logic on demand (pre-emptively by expiry or reactively on 401)

Out of scope:
- Domain endpoints (Phase 5)
- UI implementation (Android/Web) beyond basic flow wiring (phases 6/7)

## Ktor plugins / libraries
- Server auth/session:
  - `io.ktor:ktor-server-auth` (bearer + session auth providers)
  - `io.ktor:ktor-server-sessions` (HTTP-only cookie session)
- Raindrop API calls:
  - `io.ktor:ktor-client-core`
  - `io.ktor:ktor-client-content-negotiation`
  - `io.ktor:ktor-serialization-kotlinx-json`
  - HTTP engine (server): `io.ktor:ktor-client-cio`

Note:
- We are not using Ktor’s server-side OAuth callback helper in v1; clients obtain the Raindrop `code` and POST it to `/v1/auth/raindrop/exchange`.

## Client auth flow (web + android)
- Client calls `/v1/auth/raindrop/start` and opens the returned authorize URL.
- Raindrop redirects back to the client redirect URI with `code` + `state`.
- Client POSTs `code` (+ `state`, `redirectUri`, and optional `codeVerifier`) to `/v1/auth/raindrop/exchange`.
- Backend exchanges the code for Raindrop tokens, stores them, and issues LinkStash auth:
  - Web: set HTTP-only cookie (no bearer token returned to JS).
  - Android: return bearer token in JSON.

## Recommended session strategy
- Opaque session token generated by server.
- Store **hash** of token in `sessions`.
- Web: HTTP-only cookie (SameSite=Lax).
- Mobile: `Authorization: Bearer <token>`.

## Tasks (checklist)
- [ ] Ktor auth/session setup:
  - [ ] Install `Sessions` and configure cookie attributes (httpOnly, SameSite, Secure in prod)
  - [ ] Install `Authentication`:
    - [ ] `session { ... }` provider that reads cookie session id and validates it against `sessions`
    - [ ] `bearer { ... }` provider that validates `Authorization` tokens against `sessions`
- [ ] OAuth start:
  - [ ] Generate `state` (and PKCE verifier/challenge if used)
  - [ ] Persist `oauth_states` with TTL
  - [ ] Return Raindrop authorize URL
- [ ] OAuth exchange:
  - [ ] Validate `state`
  - [ ] Exchange `code` → Raindrop tokens (store encrypted)
  - [ ] Fetch Raindrop user id; upsert `users`
  - [ ] Create LinkStash session:
    - [ ] Web: set HTTP-only cookie
    - [ ] Android: return bearer token JSON
- [ ] Logout:
  - [ ] Delete/expire session record
- [ ] Raindrop refresh:
  - [ ] Refresh on expiry
  - [ ] Handle refresh failures (require re-auth)

## Deliverables
- Working login on at least one client (even a curl/manual test) using Raindrop account.

## Acceptance criteria
- A user can authenticate once and make authenticated API calls using LinkStash session auth.
- Raindrop token refresh happens without user interaction when tokens expire.
